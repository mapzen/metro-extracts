{% extends "layout.html" %}

{% block styles %}
  h1 {
    text-transform: capitalize;
    text-align: center;
    margin-bottom: 20px;
  }
  body.data-pages #map {
    width: 100%;
    height: 600px;
    border: 1px solid #ddd;
  }
  #map path {
    fill: #d4645c;
    stroke: #d4645c;
    stroke-width: 2;
    stroke-opacity: .3;
    fill-opacity: .3;
  }
  #map path.blue {
    fill: #6ea0a4;
    stroke: #6ea0a4;
  }
  #map path.outline {
    stroke: #000;
    fill: transparent;
  }
  .leaflet-container a {
    color: #6ea0a4;
  }
  .leaflet-container .leaflet-control-zoom-in,
  .leaflet-container .leaflet-control-zoom-out {
    color: #000;
  }
  .link {
    border: 1px solid #ddd;
    display: inline-block;
    padding: 5px 15px;
    margin: 0 10px 10px 0;
  }
  @media (max-width: 768px) {
    body.data-pages #map {
      height: 300px;
    }
  }
{% endblock %}

{% block content %}
  <div class="container-fluid">
    <div class="col-xs-12">
      <h1>Metro Extract: {{ metro.name }}</h1>
    </div>
    <div class="col-sm-6 col-xs-12">
      <div id="map"></div>
    </div>
    <div class="col-sm-6 col-xs-12">
      <p>To get started with <span class="name">{{ metro.name }}</span>, download your preferred file format.</p>
      <p>Need help deciding? Check out our <a href="https://mapzen.com/documentation/metro-extracts/overview/#choose-a-file-format">format guide</a>.</p>
      <div id="downloads">
        <a class="link" href="https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ metro.id }}.osm.pbf">OSM PBF</a>
        <a class="link" href="https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ metro.id }}.osm.xml">OSM XML</a>
        <a class="link" href="https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ metro.id }}.osm2pgsql-shapefiles.zip">OSM2PGSQL SHP</a>
        <a class="link" href="https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ metro.id }}.osm2pgsql-geojson.zip">OSM2PGSQL GEOJSON</a>
        <a class="link" href="https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ metro.id }}.imposm-shapefiles.zip">IMPOSM SHP</a>
        <a class="link" href="https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ metro.id }}.imposm-geojson.zip">IMPOSM GEOJSON</a>
        <a class="link" href="https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ metro.id }}.water.coastline.zip">WATER COASTLINE SHP</a>
        <a class="link" href="https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ metro.id }}.land.coastline.zip">LAND COASTLINE SHP</a>
      </div>
      {% if wof_id and wof_name %}
      <div id="encompassed">
        <p>If you'd like to clip this extract to just {{wof_name}}, please use this outline:</p>
        <a class="link" href="{{ url_for('Metro-Extracts.wof_geojson', id=wof_id)}}">{{wof_name}} GEOJSON</a>
      </div>
      {% endif %}
      <h2>About</h2>
      <p>Mapzen Metro Extracts are produced via a <a href="https://github.com/mapzen/chef-metroextractor">chef cookbook</a> derived from the work of <a href="http://metro.teczno.com">Michal Migurski</a>.</p>
      <p>For more granular OpenStreetMap data, we offer a free, hosted <a href="https://mapzen.com/documentation/vector-tiles/">Vector Tile service</a> â€” sign up for your <a href="https://mapzen.com/developers/">API key here</a>.</p>
      <div class="btn-group">
        <a class="btn btn-transparent" href="https://mapzen.com/documentation/metro-extracts/overview/#choose-a-file-format">File Format Guide</a>
        <a class="btn btn-transparent" href="https://mapzen.com/documentation/metro-extracts/">Documentation</a>
        <a class="btn btn-transparent" href="https://mapzen.com/documentation/metro-extracts/walkthrough/">Tutorial</a>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  var Metro = function (){
    var displayMap;
    var metro = {{metro|tojson|safe}};

    var MetroApp = {
      hasWebGL: function() {
        try {
          var canvas = document.createElement('canvas')
          return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')))
        } catch (x) {
          return false
        }
      },
      initDisplayMap: function() {
        var southwest = L.latLng(metro.bbox.bottom, metro.bbox.right),
          northeast = L.latLng(metro.bbox.top, metro.bbox.left),
          options = {
            scrollWheelZoom: false,
            // Disables dragging on touch-detected devices
            dragging: (window.self !== window.top && L.Browser.touch) ? false : true,
            tap: (window.self !== window.top && L.Browser.touch) ? false : true,
          };
        displayMap = L.map('map', options).fitBounds(L.latLngBounds(southwest, northeast));

        if (this.hasWebGL() === true) {
          var layer = Tangram.leafletLayer({
            scene: '../static/scene.yaml',
            attribution: '<a href="https://mapzen.com/tangram">Tangram</a> | &copy; OSM contributors | <a href="https://mapzen.com/">Mapzen</a>'
          });
        } else {
          var layer = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
          });
        }
        layer.addTo(displayMap);

        var rect = new L.Rectangle(new L.LatLngBounds([southwest, northeast]), { className : "blue" });
        displayMap.addLayer(rect);

        return this;
      },
      addEnclosed: function() {
        var id = request.split("&")[0],
          name = decodeURIComponent(request.split("&")[1]);

        var div = d3.select("#encompassed");
        div.style("display","block")
          .selectAll(".name").text(name);
        div.select(".link").attr("href","/wof/"+id+".geojson");
      }
    };
    return MetroApp;
  }

  var metroPage = Metro();
  metroPage.initDisplayMap();

  if (window.location.search)
    metroPage.addEnclosed(window.location.search.split("?")[1]);

{% endblock %}
